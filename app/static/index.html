<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Records API - Управление записями</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <!-- Весь ваш HTML без изменений -->
    <div class="header">
        <h1>Records API</h1>
        <p class="header-subtitle">Управление записями</p>
        <span class="status-badge" id="statusBadge">Проверка...</span>
    </div>

    <div class="container">
        <div class="layout">
            <aside class="sidebar">
                <div class="card">
                    <div class="card-header">Новая запись</div>
                    <div class="card-body">
                        <form id="recordForm">
                            <div class="form-group">
                                <label for="title">Название *</label>
                                <input type="text" id="title" placeholder="Введите название..." minlength="2" maxlength="75" required>
                            </div>
                            <div class="form-group">
                                <label for="details">Описание</label>
                                <textarea id="details" placeholder="Введите описание (опционально)..." maxlength="500"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="recordDate">Дата записи</label>
                                <input type="datetime-local" id="recordDate">
                            </div>
                            <div class="form-group">
                                <div class="checkbox-wrapper">
                                    <input type="checkbox" id="isDone">
                                    <label for="isDone">Отмечена как завершённая</label>
                                </div>
                            </div>
                            <button type="submit" class="button button-primary">Создать запись</button>
                        </form>
                        <div class="divider"></div>
                        <button id="clearFiltersBtn" class="button button-secondary">Очистить фильтры</button>
                    </div>
                </div>
            </aside>

            <main class="main-content">
                <div class="filters-bar">
                    <div class="filter-control">
                        <label for="searchInput">Поиск</label>
                        <input type="text" id="searchInput" placeholder="По названию или описанию...">
                    </div>
                    <div class="filter-control">
                        <label for="filterDone">Статус</label>
                        <select id="filterDone">
                            <option value="">Все записи</option>
                            <option value="false">В работе</option>
                            <option value="true">Завершены</option>
                        </select>
                    </div>
                    <div class="filter-control">
                        <label for="sortBy">Сортировать по</label>
                        <select id="sortBy">
                            <option value="created_at">Дате создания</option>
                            <option value="title">Названию</option>
                            <option value="record_date">Дате записи</option>
                            <option value="is_done">Статусу</option>
                        </select>
                    </div>
                    <div class="filter-control">
                        <label for="sortOrder">Порядок</label>
                        <select id="sortOrder">
                            <option value="desc">Новые сверху</option>
                            <option value="asc">Старые сверху</option>
                        </select>
                    </div>
                </div>

                <div id="alertContainer"></div>

                <div class="card">
                    <div class="card-header">Записи</div>
                    <div class="card-body">
                        <div id="recordsList" class="records-container">
                            <div class="loading-state">
                                <div class="spinner"></div>
                                <p>Загрузка записей...</p>
                            </div>
                        </div>
                        <div class="pagination" id="paginationContainer" style="display: none;">
                            <button id="prevBtn">Предыдущая</button>
                            <span class="pagination-info" id="pageInfo"></span>
                            <button id="nextBtn">Следующая</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ✅ ИСПРАВЛЁННЫЙ JavaScript -->
    <script>
        const API_URL = window.location.origin;
        let currentPage = 0;
        const limit = 10;
        let filters = { q: '', is_done: null, sort: 'created_at', order: 'desc' };

        // ✅ ДИНАМИЧЕСКАЯ перезапись опций порядка
        function updateSortOrderOptions() {
            const sortBy = document.getElementById('sortBy').value;
            const sortOrderSelect = document.getElementById('sortOrder');

            if (sortBy === 'is_done') {
                sortOrderSelect.innerHTML = `
                    <option value="asc">Сначала рабочие</option>
                    <option value="desc">Сначала завершённые</option>
                `;
            } else {
                sortOrderSelect.innerHTML = `
                    <option value="desc">Новые сверху</option>
                    <option value="asc">Старые сверху</option>
                `;
            }
        }

        // Загрузка записей
        async function loadRecords() {
            const recordsList = document.getElementById('recordsList');
            recordsList.innerHTML = `
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Загрузка записей...</p>
                </div>
            `;

            try {
                const params = new URLSearchParams({
                    offset: currentPage * limit,
                    limit: limit,
                    sort: filters.sort,
                    order: filters.order
                });

                if (filters.q) params.append('q', filters.q);
                if (filters.is_done !== null) params.append('is_done', filters.is_done);

                const response = await fetch(`${API_URL}/records?${params}`);
                if (!response.ok) throw new Error('Ошибка загрузки');

                const records = await response.json();
                renderRecords(records);
            } catch (error) {
                showAlert('Ошибка загрузки записей: ' + error.message, 'error');
                console.error(error);
            }
        }

        function renderRecords(records) {
            const recordsList = document.getElementById('recordsList');

            if (records.length === 0) {
                recordsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">[]</div>
                        <div class="empty-state-title">Нет записей</div>
                        <p class="empty-state-text">Создайте новую запись, чтобы начать</p>
                    </div>
                `;
                updatePagination(false);
                return;
            }

            recordsList.innerHTML = records.map(record => `
                <div class="record-item ${record.is_done ? 'completed' : ''}">
                    <div class="record-head">
                        <div class="record-title">${escapeHtml(record.title)}</div>
                        <span class="record-id">#${record.id}</span>
                    </div>
                    <div class="record-meta">
                        <div class="meta-item">
                            <span class="meta-label">Создана:</span>
                            ${formatDate(record.created_at)}
                        </div>
                        ${record.record_date ? `
                            <div class="meta-item">
                                <span class="meta-label">Дата записи:</span>
                                ${formatDate(record.record_date)}
                            </div>
                        ` : ''}
                        ${record.updated_at ? `
                            <div class="meta-item">
                                <span class="meta-label">Обновлена:</span>
                                ${formatDate(record.updated_at)}
                            </div>
                        ` : ''}
                    </div>
                    ${record.details ? `<div class="record-desc">${escapeHtml(record.details)}</div>` : ''}
                    <div class="record-status">
                        <span class="status-badge-item ${record.is_done ? 'done' : 'pending'}">
                            ${record.is_done ? 'Завершена' : 'В работе'}
                        </span>
                    </div>
                    <div class="record-actions">
                        <button class="button button-success button-sm" onclick="toggleRecord(${record.id})">
                            ${record.is_done ? 'Вернуть в работу' : 'Отметить завершённой'}
                        </button>
                        <button class="button button-danger button-sm" onclick="deleteRecord(${record.id})">
                            Удалить
                        </button>
                    </div>
                </div>
            `).join('');

            updatePagination(records.length === limit);
        }

        // Инициализация после загрузки DOM
        document.addEventListener('DOMContentLoaded', function() {
            // Обработчики
            document.getElementById('sortBy').addEventListener('change', function(e) {
                filters.sort = e.target.value;
                updateSortOrderOptions();
                filters.order = filters.sort === 'is_done' ? 'asc' : 'desc';
                currentPage = 0;
                loadRecords();
            });

            document.getElementById('sortOrder').addEventListener('change', function(e) {
                filters.order = e.target.value;
                currentPage = 0;
                loadRecords();
            });

            document.getElementById('searchInput').addEventListener('input', function(e) {
                filters.q = e.target.value;
                currentPage = 0;
                loadRecords();
            });

            document.getElementById('filterDone').addEventListener('change', function(e) {
                filters.is_done = e.target.value === '' ? null : e.target.value === 'true';
                currentPage = 0;
                loadRecords();
            });

            document.getElementById('clearFiltersBtn').addEventListener('click', function() {
                filters = { q: '', is_done: null, sort: 'created_at', order: 'desc' };
                currentPage = 0;
                document.getElementById('searchInput').value = '';
                document.getElementById('filterDone').value = '';
                document.getElementById('sortBy').value = 'created_at';
                updateSortOrderOptions();
                loadRecords();
            });

            document.getElementById('recordForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = {
                    title: document.getElementById('title').value,
                    details: document.getElementById('details').value || null,
                    record_date: document.getElementById('recordDate').value ?
                        new Date(document.getElementById('recordDate').value).toISOString() : null,
                    is_done: document.getElementById('isDone').checked
                };

                try {
                    const response = await fetch(`${API_URL}/records`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Ошибка создания');
                    }
                    showAlert('Запись создана!', 'success');
                    this.reset();
                    currentPage = 0;
                    loadRecords();
                } catch (error) {
                    showAlert('Ошибка: ' + error.message, 'error');
                }
            });

            // Пагинация
            document.getElementById('prevBtn').addEventListener('click', function() {
                if (currentPage > 0) {
                    currentPage--;
                    loadRecords();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });

            document.getElementById('nextBtn').addEventListener('click', function() {
                currentPage++;
                loadRecords();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // Инициализация
            updateSortOrderOptions();
            checkServerStatus();
            loadRecords();
            setInterval(checkServerStatus, 30000);
        });

        // Глобальные функции
        async function toggleRecord(id) {
            try {
                const response = await fetch(`${API_URL}/records/${id}`);
                const record = await response.json();
                const updateResponse = await fetch(`${API_URL}/records/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_done: !record.is_done })
                });
                if (!updateResponse.ok) throw new Error('Ошибка обновления');
                showAlert('Статус обновлён', 'success');
                loadRecords();
            } catch (error) {
                showAlert('Ошибка: ' + error.message, 'error');
            }
        }

        async function deleteRecord(id) {
            if (!confirm('Вы уверены? Это действие нельзя отменить.')) return;
            try {
                const response = await fetch(`${API_URL}/records/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Ошибка удаления');
                showAlert('Запись удалена', 'success');
                loadRecords();
            } catch (error) {
                showAlert('Ошибка: ' + error.message, 'error');
            }
        }

        function updatePagination(hasMore) {
            const container = document.getElementById('paginationContainer');
            if (currentPage > 0 || hasMore) {
                container.style.display = 'flex';
                document.getElementById('prevBtn').disabled = currentPage === 0;
                document.getElementById('nextBtn').disabled = !hasMore;
                document.getElementById('pageInfo').textContent = `Страница ${currentPage + 1}`;
            } else {
                container.style.display = 'none';
            }
        }

        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const statusBadge = document.getElementById('statusBadge');
                if (response.ok) {
                    statusBadge.textContent = 'API Online';
                    statusBadge.className = 'status-badge online';
                } else {
                    statusBadge.textContent = 'API Offline';
                    statusBadge.className = 'status-badge offline';
                }
            } catch (error) {
                document.getElementById('statusBadge').textContent = 'API Offline';
                document.getElementById('statusBadge').className = 'status-badge offline';
            }
        }

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 4000);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString('ru-RU', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
